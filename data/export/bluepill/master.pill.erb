Bluepill.application("<%= app %>", :foreground => false) do |app|

  app.uid = "<%= user %>"
  app.gid = "<%= user %>"

<% engine.processes.values.each do |process| %>
<% 1.upto(concurrency[process.name]) do |num| %>
<% port = engine.port_for(process, num, options[:port]) %>
  app.process("<%= process.name %>-<%=num%>") do |process|
    process.start_command = "<%= process.command %>"

    process.working_dir = "<%= engine.directory %>"
    process.pid_file = "/var/run/<%= app %>-<%= process.name %>-<%=num%>.pid"
    process.daemonize = true
    process.environment = {"PORT" => "<%= port %>"}

    process.stdout = process.stderr = "<%= log_root %>/<%= app %>-<%= process.name %>-<%=num%>.log"

    process.monitor_children do |children|
      children.stop_command "kill -QUIT {{PID}}"
    end
  end
<% end %>
<% end %>
end